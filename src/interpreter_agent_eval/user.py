"""User class for representing conversation participants."""

from typing import Optional, Dict, Any


class User:
    """Represents a user in the conversation with a specific language.
    
    Users can be either human users or LLM-powered users.
    """
    
    def __init__(
        self,
        name: str,
        language: str,
        is_llm: bool = False,
        llm_provider: Optional[Any] = None,
        context: Optional[str] = None
    ):
        """Initialize a User.
        
        Args:
            name: Name/identifier for the user
            language: Language the user speaks (e.g., 'English', 'Spanish', 'French')
            is_llm: Whether this user is powered by an LLM
            llm_provider: LLM provider instance if is_llm is True
            context: Context information for the user
        """
        self.name = name
        self.language = language
        self.is_llm = is_llm
        self.llm_provider = llm_provider
        self.context = context
        self.conversation_history = []
    
    def send_message(self, message: str, metadata: Optional[Dict[str, Any]] = None) -> str:
        """Send a message from this user.
        
        Args:
            message: The message content
            metadata: Optional metadata about the message
            
        Returns:
            The message (potentially generated by LLM if is_llm is True)
        """
        if self.is_llm and self.llm_provider:
            # Generate response using LLM
            prompt = self._build_prompt(message)
            response = self.llm_provider.generate(prompt)
            self.conversation_history.append({
                "role": "assistant",
                "content": response,
                "metadata": metadata
            })
            return response
        else:
            # For human users, just record and return the message
            self.conversation_history.append({
                "role": "user",
                "content": message,
                "metadata": metadata
            })
            return message
    
    def receive_message(self, message: str, metadata: Optional[Dict[str, Any]] = None):
        """Receive a message for this user.
        
        Args:
            message: The received message
            metadata: Optional metadata about the message
        """
        self.conversation_history.append({
            "role": "received",
            "content": message,
            "metadata": metadata
        })
    
    def _build_prompt(self, message: str) -> str:
        """Build a prompt for LLM-powered users.
        
        Args:
            message: The incoming message to respond to
            
        Returns:
            Formatted prompt for the LLM
        """
        prompt_parts = []
        
        if self.context:
            prompt_parts.append(f"Context: {self.context}")
        
        prompt_parts.append(f"You are speaking in {self.language}.")
        
        if self.conversation_history:
            prompt_parts.append("\nConversation history:")
            for msg in self.conversation_history[-5:]:  # Last 5 messages
                role = msg["role"]
                content = msg["content"]
                prompt_parts.append(f"{role}: {content}")
        
        prompt_parts.append(f"\nIncoming message: {message}")
        prompt_parts.append(f"\nRespond in {self.language}:")
        
        return "\n".join(prompt_parts)
    
    def get_conversation_history(self) -> list:
        """Get the conversation history for this user.
        
        Returns:
            List of conversation messages
        """
        return self.conversation_history
